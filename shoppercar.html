<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="./css/shopper_car.css">
    <link rel="stylesheet" href="./font_2tjxvl4sb8l/iconfont.css">
    <link rel="stylesheet" href="./css/reset.css">
</head>

<body>
    <div id="nav">
        <div id="nav-wrap">
            <ul class="nav_l">
                <li class="l_na">
                    <a href="">首页</a>
                </li>
                <li>
                    <a href="">华为官网</a>
                </li>
                <li>
                    <a href="">荣耀官网</a>
                </li>
                <li>
                    <a href="">花粉俱乐部</a>
                </li>
                <li>
                    <a href="">V码(优购码)</a>
                </li>
                <li>
                    <a href="">企业购</a>
                </li>
                <li>
                    <a href="">Select Region</a>
                </li>
                <li class="nav_l1">
                    <a href="" class="">更多精彩</a>
                    <ul class="nav_l2">
                        <li>
                            <a href="">EMUI</a>
                        </li>
                        <li>
                            <a href="">应用市场</a>
                        </li>
                        <li>
                            <a href="">华为终端云空间</a>
                        </li>
                        <li>
                            <a href="">开发者联盟</a>
                        </li>
                    </ul>
                </li>
            </ul>
            <ul class="nav_r">
                <li>
                    <a id="btnLogin" href="./login.html">请登录</a>
                    <div class="user">
                        欢迎：<span class="userSpan"></span>
                        <input class="userOut" type="button" value="注销">
                    </div>
                </li>
                <img src="./img/images/q1.jpg" alt="">
                <li>
                    <a href="">注册</a>
                </li>
                <img src="./img/images/q1.jpg" alt="">
                <li>
                    <a href="">我的订单</a>
                </li>
                <img src="./img/images/q1.jpg" alt="">
                <li>
                    <a href="">客户服务</a>
                </li>
                <img src="./img/images/q1.jpg" alt="">
                <li>
                    <a href="">导航服务</a>
                </li>
                <img src="./img/images/q1.jpg" alt="">

            </ul>
        </div>
    </div>
    <div id="nav_shop">
        <div class="nav_shopmin">
            <a href="">
                <img src="./img/shopp-1.png" alt="">
            </a>
            <span>我的购物车</span>
        </div>

    </div>
    <div id="shopper">
        <!-- <div class="shop_yin">
            <div class="shop_login">
                <span>你还没登陆无法查看购物车信息</span>
                <a href="">登陆</a>
            </div>
        </div> -->

        <div class="shop_empty">
            <table class="ta">
                <tbody>
                    <!-- <div class="all">全选：<input type="checkbox"></div> -->


                </tbody>
            </table>
            <p>总计：￥<span>4399</span></p>
            <div class="total"></div>
        </div>
    </div>

    <div id="goods">
        <div class="goods_head">
            <h2>精品推荐</h2>
        </div>
        <div class="goods_box">
            <ul class="box_2">
                <li>
                    <a href="">
                        <p>
                            <img src="./img/jing/22.png" alt="">
                        </p>
                        <div>荣耀V30</div>
                        <span>晒单赠好礼</span>
                        <span>￥2999</span>
                    </a>
                </li>
                <li>
                    <a href="">
                        <p>
                            <img src="./img/jing/33.png" alt="">
                        </p>
                        <div>荣耀20青春版</div>
                        <span>尊享24期免息</span>
                        <span>￥1099</span>
                    </a>
                </li>
                <li>
                    <a href="">
                        <p>
                            <img src="./img/jing/44.png" alt="">
                        </p>
                        <div>荣耀20S</div>
                        <span>享12期免息 </span>
                        <span>￥1699</span>
                    </a>
                </li>
                <li>
                    <a href="">
                        <p>
                            <img src="./img/jing/55.png" alt="">
                        </p>
                        <div>HUAWEI Mate 30 RS 保时捷设计</div>
                        <span>晒单赠好礼</span>
                        <span>￥12999</span>
                    </a>
                </li>
                <li>
                    <a href="">
                        <p>
                            <img src="./img/jing/66.png" alt="">
                        </p>
                        <div>HUAWEI Mate 30 RS 保时捷设计</div>
                        <span>晒单赠好礼</span>
                        <span>￥12999</span>
                    </a>
                </li>

            </ul>
        </div>
    </div>

    <div id="footer">

        <div class="foot-server">
            <div class="foot-l">
                <ul>
                    <li>购物相关</li>
                    <li>购物指南</li>
                    <li>配送方式</li>
                    <li>支付方式</li>
                    <li>常见问题</li>
                </ul>
                <ul>
                    <li>保修与退货</li>
                    <li>保修政策</li>
                    <li>退换货流程</li>
                    <li>保修状态</li>
                    <li>配件防伪查询</li>
                </ul>
                <ul>
                    <li>维修与技术支持</li>
                    <li>购物指南</li>
                    <li>配送方式</li>
                    <li>支付方式</li>
                    <li>常见问题</li>
                </ul>
                <ul>
                    <li>特色服务</li>
                    <li>购物指南</li>
                    <li>配送方式</li>
                    <li>支付方式</li>
                    <li>常见问题</li>
                </ul>
                <ul>
                    <li>关于我们</li>
                    <li>购物指南</li>
                    <li>配送方式</li>
                    <li>支付方式</li>
                    <li>常见问题</li>
                </ul>
            </div>
            <div class="foot-r">
                <div>950805</div>
                <span>7x24小时客服热线（仅收市话费）</span>
                <div>
                    <a href="">在线客服</a>
                </div>
            </div>
        </div>
    </div>

</body>

</html>
<script src="js/jquery-3.2.1.min.js"></script>
<script src="./js/cookieTools.js"></script>
<script src="js/check.js"></script>
<!-- <script src="./js/shopperlist.js"></script> -->
<script>
    $(function () {
        let username = getCookie("userName");
        let local_goodsId = location.search.split("=")[1];
        user_Login(username)
        $("#nav .nav_r .user .userOut").click(function () {
            removeCookie("userName")
            user_Login()
        })

        shoppercar(username, addEvent);

    })

    function shoppercar(username, cb) {
        $.get("./php/getShoppingCart.php", {
            "vipName": username
        }, function (data) {
            let htmlstr = "";

            data.forEach(item => {
                let tota = item.goodsPrice * item.goodsCount
                htmlstr += `
                    <tr>
                        <td><input type="checkbox"></td>
                        <td><img src="${item.goodsImg}" alt=""></td>
                        <td>
                            <p>${item.goodsName}</p>
                            <p>${item.goodsId}</p>
                        </td>
                        <td>￥<span>${item.goodsPrice}</span></td>
                        <td>
                            <input class="reduceBtn" type="button" value="-">
                            <span id="count" >${item.goodsCount}</span>
                            <input class="addBtn" type="button" value="+">
                        </td>
                        <td>￥<span>${tota}</span></td>
                        <td><input class="delBtn" type="button" value="×"></td>
                    </tr>
                `
                $("#shopper .ta>tbody").html(htmlstr)
            });
            cb()
        }, "json")


    }


    function updateCount(vipName, goodsId, goodsCount, cb) {
        $.get("./php/updateGoodsCount.php", {
            "vipName": vipName,
            "goodsId": goodsId,
            "goodsCount": goodsCount
        }, function (data) {
            if (data == 1) {
                cb()
            } else {
                alert("修改数量出错")
            }
        })
    }

    function del(vipName, goodsId, cb) {
        $.get("./php/deleteGoods.php", {
            "vipName": vipName,
            "goodsId": goodsId
        }, function (data) {
            if (data == 1) {
                cb()
            } else if (data == 0) {
                alert("删除失败")
            }
        })
    }


    function addEvent() {
        let username = getCookie("userName");
        
        // $(".all>input :checkbox:eq(0)").check($("tr td  input:checkbox"));
        $("input:checkbox").click(function () {
            total();
        })
        $(".reduceBtn").click(function () {
            let count = $(this).next().html();
            let goodsId = $(this).parent().prev().prev().children().eq(1).html()
            count--;
            if (count < 1) {
                count = 0;
            }
            updateCount(username, goodsId, count, () => {
                $(this).next().html(count);
                let price = $(this).parent().prev().children().html();
                let money = price * count;
                $(this).parent().next().children().html(money);

                if (count == 0) {
                    $(this).parent().parent().find(":checkbox").prop("checked", false)
                }

                total();
            })


        })

        $(".addBtn").click(function () {
            let count = $(this).prev().html();
            count++;
            let goodsId = $(this).parent().prev().prev().children().eq(1).html()
            updateCount(username, goodsId, count, () => {
                $(this).prev().html(count);
                let price = $(this).parent().prev().children().html();
                let money = price * count;
                $(this).parent().next().children().html(money);
                total();
            })


        })

        $(".delBtn").click(function () {
            let username = getCookie("userName");
            let goodsId = $(this).parent().prev().prev().children().eq(1).html()
            if (confirm("尊敬的客户，请问您确定要删除吗？")) {
            del(username,goodsId,()=>{
                $(this).parent().parent().remove();
            })
        }
        })

    }


    function user_Login(username) {

        if (username == null) {
            $("#nav .nav_r .user").hide()
            $("#btnLogin").show()
        } else {
            $("#nav .nav_r .userSpan").html(username)
            $("#nav .nav_r .user").show()
            $("#btnLogin").hide()

        }

    }



    function total() {
        let cash = 0;
        let $tr = $("table tr");
        $tr.each(function () {

            if ($(this).find("input:checkbox").prop("checked") == true) {
                cash += parseFloat($(this).find("td").eq(5).children().html());
            }
        });
        $("table").next().children().html(cash);
    }
</script>